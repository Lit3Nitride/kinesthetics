var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}if(typeof module!=="undefined")var fs=require("fs"),path=require("path");var VAL="(?:\"[^\"\\r\\n]*\"|'[^'\\r\\n]*'|\\S*)",KEY="[a-zA-Z0-9\\-_]*",NUMKEY="[a-zA-Z0-9\\-_\\.]*",NUM="\\-?[0-9]*\\.?[0-9]+",WS2=/(?: {2,}|[\r\n])/gm,ID="#"+KEY,CLASS="(?:\\."+KEY+")*",ABS_SCRIPT=/^ *[\"\']? *(?:\/|http)/;function unquote(str){str=str.trim();if(str.length>0){if(str[0].match(/['"]/)!=null)str=str.substr(1,str.length-1);if(str[str.length-1].match(/['"]/)!=null)str=str.substr(0,str.length-1)}return str.trim()}function classify(c,id){c=c?c.replace(/\./g," ").trim():false;id=id?id.replace("#","").trim():false;return(c?',"class":"'+c+'"':"")+(id?',"id":"'+id+'"':"")}function preParse(content){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var callback=arguments[2];if(typeof options=="function"){callback=options;options={}}var _options=options,valuedTypes=_options.valuedTypes,dir=_options.dir;valuedTypes=valuedTypes||[];dir=dir||"";content=content.replace(/[\n\r]^\s*$/gm,"").replace(/ *$/gm,"").replace(/\/\*([\s\S](?!\*(?!\/)))*\*\//gm,"").replace(/\/\/[^\n\r]*$/gm,"").replace(/\[([^\]]*)\]\s*([\,\}]?)/gm,function(str,val,next){val=val.replace(/\s/gm,"").split(",");val.forEach(function(str,i){var matchedStr=str.match(new RegExp(NUM));val[i]=matchedStr&&matchedStr[0]==str?str.replace(new RegExp("("+NUM+")","g"),function(a,num){return num.replace(/^(-?)\./,"$10.")}):'"'+unquote(str)+'"'});next=next||"\n";return"["+val.join(",")+"]"+next}).replace(/\}\s*,\s*/gm,"},").replace(/([^:]|^)\s*(\{(?:[\s\S](?!\}\s*\}))+[\s\S]\}\s*\})/g,function(a,start,str){str=str.replace(/:\s*(((?:[^\}\{\s,](?!\}|,))*[^\}\{\s,]?\s*)*)/gm,function(a,val){val=val.trim().replace(new RegExp("("+NUM+")","g"),function(a,num){return(num[0]=="."?"0":"")+num});if(val.match(/\[/)==null&&val.replace(new RegExp("(?:"+NUM+"| )"),"")!="")val='"'+unquote(val)+'"';return":"+val}).replace(WS2," ").replace(WS2," ").replace(new RegExp("(\\,|\\{)\\s*(\\{|(?:(?:(?:"+NUM+"|default)\\s*,?\\s*)+:))","gmi"),function(a,brace,key){return brace+key.replace(/\s/g,"")}).replace(/\}\s*\}/gm,"}}").replace(new RegExp("([\\{|,])"+("((?:(?:"+NUM+"|default),)+)")+("("+NUM+"|default):(\\{(?:[^\\}])*\\})"),"ig"),function(a,str,n0,n1,rule){str+=(n0+n1+",").replace(/,/g,":"+rule+",");return str.substr(0,str.length-1)}).replace(new RegExp("([\\{,]) *("+NUMKEY+") *(?=:)","g"),function(str,start,key){return start+'"'+unquote(key)+'"'});str=str.substr(1,str.length-2);var t=true,ts={},re=new RegExp('(?:^|,)("'+NUMKEY+'"):\\{([^\\{\\}]*)\\}',"g"),tStr="";while(t!=null){if(t[1])ts[t[1]]=(ts[t[1]]?ts[t[1]]+",":"")+t[2];t=re.exec(str)}for(var key in ts){tStr+=key+":{"+ts[key]+"},"}return start+' "state":{'+tStr.substr(0,tStr.length-1)+"}"}).replace(new RegExp("([\\r\\n]? *)("+KEY+"|'"+KEY+"'|\""+KEY+'") *('+CLASS+")("+ID+")?("+CLASS+") *= *("+VAL+")( *)","g"),function(a,prev,key,c1,id,c2,val,next,offset,all){key=unquote(key);val=unquote(val);if(prev.match(/[\r\n]/)!=null||offset==0){prev+='"type":"'+key.toLowerCase()+'",';key=valuedTypes[key.toLowerCase()]||"src"}if(key=="src")val=path.join(dir,val);key='"'+key+'":"'+val+'"';return prev+key+classify(c1+c2,id)+(next?",":"")}).replace(/^(\s*)((?:\S(?![,\{\r\n]))*.)/gm,function(str,spaces,keygroup){if(keygroup.indexOf(":")!=-1){return str}else{keygroup=keygroup.replace(new RegExp("^([^#\\. ]*)("+CLASS+")("+ID+")?("+CLASS+")([ \\{\\=]?)"),function(str,key,c1,id,c2,next){return'"type":"'+unquote(key)+'"'+classify(c1+c2,id)+(next?",":"")});return spaces+keygroup}});content=content.replace("\t","    ").split(/[\r\n]/);var globals=[],i=0;while(typeof content[i]!="undefined"){if(content[i].indexOf('"type":')==-1&&content[i].indexOf('"state":')==-1){globals=[].concat(_toConsumableArray(globals),[content.splice(i,1)[0].replace(new RegExp(" *("+KEY+") *:(.*)$"),function(str,key,val){if(key=="scripts"){if(val.indexOf("[")==-1){if(script.match(ABS_SCRIPT)==null)val=path.join(dir,val)}else{val=val.replace(/^ *\[/,"").replace(/\] *$/,"").split(",");val.forEach(function(script,i){if(script.match(ABS_SCRIPT)==null)val[i]='"'+path.join(dir,unquote(script))+'"'});val="["+val.join(",")+"]"}}return'"'+unquote(key)+'":'+(val.indexOf("[")==-1?'"'+unquote(val)+'"':val)})])}else{content[i]=content[i++].replace(/( *)([\s\S]*)/,"$1{$2}")}}return{globals:globals,content:content}}function objectify(globals,content){var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var callback=arguments[3];if(typeof options=="function"){callback=options;options={}}var level=typeof options=="number"?options:options.level||0,rootDir=typeof options=="string"?options:options.rootDir||"",object={},slides=[],j=[],jNum=0,objectified=0,currContent=void 0,doCallback=function doCallback(){if(objectified>=content.length){object.slides=slides;callback(null,object);return}};globals.forEach(function(val){try{val=JSON.parse("{"+val+"}")}catch(err){callback(new Error('Unable to parse JSON "'+val+'"'));return}object=_extends({},object,val)});content.push("");content.forEach(function(row,i){if(row.substr(0,(level+1)*4)==" ".repeat((level+1)*4)){j[i]=j[i-1];if(!Array.isArray(slides[j[i]].children))slides[j[i]].children=[];slides[j[i]].children.push(row);return}else{if(i>0&&Array.isArray(slides[j[i-1]].children)&&slides[j[i-1]].children.length>0){if(!slides[j[i-1]].slides)slides[j[i-1]].slides=[];objectify([],slides[j[i-1]].children,{level:level+1,rootDir:rootDir},function(err,childObject){if(err){callback(err);return}slides[j[i-1]].slides=[].concat(_toConsumableArray(slides[j[i-1]].slides),_toConsumableArray(childObject.slides));delete childObject.slides;object=_extends({},childObject,object);objectified+=slides[j[i-1]].children.length-1;delete slides[j[i-1]].children;doCallback()})}}if(!row){objectified++;doCallback();return}j[i]=i==0?0:j[i-1]+1;try{currContent=JSON.parse(row)}catch(err){callback(new Error('Unable to parse JSON "'+row+'"'));return}slides[j[i]]=currContent;if(slides[j[i]].type=="import"){fs.readFile(path.join(rootDir,slides[j[i]].src),"utf8",function(err,data){if(err&&err.code==="ENOENT"){slides[j[i]].comment="File not found - "+path.join(rootDir,slides[j[i]].src);objectified++;doCallback()}else{if(err){callback(err);return}parse(data,{rootDir:rootDir,dir:path.dirname(slides[j[i]].src)},function(err,obj){if(err){callback(err);return}if(!slides[j[i]].slides)slides[j[i]].slides=[];slides[j[i]].slides=[].concat(_toConsumableArray(slides[j[i]].slides),_toConsumableArray(obj.slides));delete obj.slides;delete slides[j[i]].src;slides[j[i]].type="slide";object=_extends({},obj,object);objectified++;doCallback()})}})}else{objectified++;doCallback()}})}function parse(content){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var callback=arguments[2];if(typeof options=="function"){callback=options;options={}}var rootDir=options.rootDir||"";delete options.rootDir;var _preParse=preParse(content,options,callback),globals=_preParse.globals,parsedContent=_preParse.content;objectify(globals,parsedContent,rootDir,function(err,obj){return callback(err,obj)})}if(typeof module!=="undefined")module.exports={parse:parse};
