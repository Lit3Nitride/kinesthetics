var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}if(typeof module!=="undefined")var _require=require("./grammar"),parse=_require.parse,fs=require("fs"),path=require("path");var customStyles=require("./styles.json","customStyles"),mimes=require("./server/mime.json","mimes");var handledKeys=["class","slides","type","state","sweep"],handledTransforms={T:{name:"translate",parse:function parse(value){switch(typeof value==="undefined"?"undefined":_typeof(value)){case"number":return value*100+"%";default:return value}}},R:{name:"rotate",parse:function parse(value){switch(typeof value==="undefined"?"undefined":_typeof(value)){case"number":return value/Math.PI*180+"deg";default:return value}}},S:{name:"scale",parse:function parse(value){return value}}},handledSweeps={left:"width",right:"width",top:"height",bottom:"height"};if(typeof module!=="undefined"&&require.main===module){var args=process.argv.splice(2),READLINE=require("readline"),readlineOpt={input:process.stdin,output:process.stdout};args.forEach(function(kstFile){var kstFileDat=path.parse(kstFile),filePath=path.join(kstFileDat.root,kstFileDat.dir);var fileName=kstFileDat.name+".html";function saveFile(html){fs.writeFile(path.join(filePath,fileName),html,{flag:"wx"},function(err){if(err&&err.code=="EEXIST"){var readline=READLINE.createInterface(readlineOpt);readline.question(fileName+" already exists in "+filePath+". Please enter another name: ",function(newName){newName=newName.trim();if(newName){fileName=newName;saveFile(html)}else{console.log("Operation cancelled.")}readline.close()})}})}if(kstFileDat.ext==".kst")render(kstFile,{renderSingle:true},function(err,html){if(err)throw err;else saveFile(html)});else console.log(kstFileDat.base+" does not seem to be a kst file.")})}function add(a,b){var returnStr=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var numP=function numP(num){return num.toString().replace(/^-/,"").replace(/\./,"").replace(/e-[0-9]*$/i,"").length};a=Number(a);b=Number(b);var aP=numP(a),bP=numP(b),abP=numP(a+b),c=(a+b).toPrecision(Math.max(aP,bP,abP,1));if(c.match(/^0\./)!=null)c=c.replace(/0*$/,"");if(!returnStr)return Number(c);var cSub=c.indexOf("e");if(cSub!=-1)c=Number(c).toFixed(Math.max(-parseInt(c.substr(cSub+1)),0));return c}function invertColour(colour){colour=colour.replace(/^#/,"");if(colour.length==3)colour=colour.split("").map(function(x){return x+x}).join("");else if(colour.length!=6)throw new Error("#"+colour+" is an invalid colour");colour=(16777215-parseInt(colour,16)).toString(16);return"#"+"0".repeat(6-colour.length)+colour}function slidesObjToHTML(slides){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{jstr:"j-"};var callback=arguments[2];if(typeof options=="function"){callback=options;options={jstr:"j-"}}var slidesHTMLobj={body:[],style:"",t:new Set},slideType={},finishedSlides=0,padding=" ".repeat(2*depth),jstr=typeof options=="string"?options:options.jstr||"j-",depth=options.depth||0,offset=options.offset||0,dir=options.dir||"",renderSingle=options.renderSingle||false;var _loop=function _loop(j){if(!slides[j].type||slides[j].type=="slide")slides[j].type="div";if(!slides[j].class)slides[j].class="";slides[j].class+=" "+jstr+j;slidesHTMLobj.body[j]="";if(typeof handledSweeps[slides[j].sweep]!="undefined"){slideType[j]=handledSweeps[slides[j].sweep];slidesHTMLobj.body[j]+='<div class="sweep sweep-'+slides[j].sweep+'" data-j="'+(jstr+j)+'"><div class="sweep-c">'}slidesHTMLobj.body[j]+="<"+slides[j].type+' class="'+slides[j].class.trim()+'"';for(var key in slides[j]){if(handledKeys.indexOf(key)==-1){var val=slides[j][key];if(renderSingle&&key=="src"){var mime=void 0,ext=path.extname(val).substr(1);for(var m in mimes){if(mimes[m].indexOf(ext)!=-1)mime=m}try{val="data:"+mime+";base64,"+Buffer.from(fs.readFileSync(path.join(dir,val))).toString("base64")}catch(err){if(err.code=="ENOENT"){console.log("Source '"+val+"' for <"+key+"> does not exist.")}else{callback(err);return{v:void 0}}}}slidesHTMLobj.body[j]+=" "+key+'="'+val+'"'}}slidesHTMLobj.body[j]+=">\n";var tmpStyle={};for(var t0Str in slides[j].state){var t0=t0Str.toLowerCase()=="default"?-Infinity:add(t0Str,offset);if(isNaN(t0)){callback(new Error('State "'+t0Str+'" is not a number'));return{v:void 0}}tmpStyle[t0]="";var transformStyles="",sweepStyle="";if(isFinite(t0)){slidesHTMLobj.t.add(add(t0,0,true));tmpStyle[t0]+=".t"+add(t0,0,true).replace(".","-")+" ";if(slideType[j])sweepStyle+=tmpStyle[t0]}tmpStyle[t0]+="."+slides[j].class.trim().replace(/ +/g,".")+" {\n";if(slideType[j])sweepStyle+='.sweep[data-j="'+(jstr+j)+'"] {';var _loop2=function _loop2(_key2){if(Object.keys(handledTransforms).indexOf(_key2)!=-1){if(typeof slides[j].state[t0Str][_key2]=="string"||typeof slides[j].state[t0Str][_key2]=="number"){var _value=handledTransforms[_key2].parse(slides[j].state[t0Str][_key2]);transformStyles+=" "+handledTransforms[_key2].name+"("+_value+")"}else{slides[j].state[t0Str][_key2].forEach(function(value,dir){value=handledTransforms[_key2].parse(value);transformStyles+=" "+handledTransforms[_key2].name+["X","Y","Z"][dir]+"("+value+")"})}}else if(_key2=="sweep"&&slideType[j]){var sweepPercent=slides[j].state[t0Str][_key2];if(typeof sweepPercent=="number")sweepPercent=sweepPercent*100+"%";sweepStyle+=slideType[j]+": "+sweepPercent+";"}else{value=slides[j].state[t0Str][_key2];value=_key2=="O"&&typeof value=="number"?value*100+"%":value;if(customStyles.value&&customStyles.value[_key2]&&customStyles.value[_key2][value])value=customStyles.value[_key2][value];if(customStyles.key&&customStyles.key[_key2]){_key2=customStyles.key[_key2];if(Array.isArray(value))value=value.join(" ")}if(slideType[j])sweepStyle+="  "+_key2+": "+value+";\n";else tmpStyle[t0]+="  "+_key2+": "+value+";\n"}_key=_key2};for(var _key in slides[j].state[t0Str]){_loop2(_key)}if(transformStyles!="")tmpStyle[t0]+="  transform:"+transformStyles+";\n";tmpStyle[t0]+="}\n";if(slideType[j])tmpStyle[t0]+=sweepStyle+"}\n"}Object.keys(tmpStyle).sort(function(a,b){return a-b}).forEach(function(key){return slidesHTMLobj.style+=tmpStyle[key]});if(_typeof(slides[j].slides)=="object"){slidesObjToHTML(slides[j].slides,{jstr:jstr+j+"-",depth:depth+1,offset:add(offset,slides[j].offset||0),dir:dir,renderSingle:renderSingle},function(err,childSlidesHTMLobj){if(err){callback(err);return}slidesHTMLobj.t=new Set([].concat(_toConsumableArray(slidesHTMLobj.t),_toConsumableArray(childSlidesHTMLobj.t)));slidesHTMLobj.style+=childSlidesHTMLobj.style;slidesHTMLobj.body[j]+=childSlidesHTMLobj.body;slidesHTMLobj.body[j]+="\n"+padding+("</"+slides[j].type+">");if(typeof slideType[j]!="undefined")slidesHTMLobj.body[j]+="</div></div>";if(++finishedSlides==slides.length){slidesHTMLobj.body=padding+slidesHTMLobj.body.join("\n"+padding);callback(null,slidesHTMLobj)}})}else{slidesHTMLobj.body[j]+=padding+("</"+slides[j].type+">");if(typeof slideType[j]!="undefined")slidesHTMLobj.body[j]+="</div></div>";if(++finishedSlides==slides.length){slidesHTMLobj.body=padding+slidesHTMLobj.body.join("\n"+padding);callback(null,slidesHTMLobj)}}};for(var j=0;j<slides.length;j++){var _ret=_loop(j);if((typeof _ret==="undefined"?"undefined":_typeof(_ret))==="object")return _ret.v}}function render(slides){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var callback=arguments[2];if(typeof options=="function"){callback=options;options={}}options.renderSingle=options.renderSingle||false;options.resourceDir=options.resourceDir||"/resources";var slidesObj={aspect:16/9,slides:"",title:"",templateFile:path.join(__dirname,options.resourceDir,"template.html"),background:"#f0f0f0",head:"",body:"",bodyStyles:""},slidesObjRendered=null,slidesPath=void 0;var slidesInjectHTML=function slidesInjectHTML(err,slidesHTMLobj){if(err){callback(err);return}var tMap=[].concat(_toConsumableArray(slidesHTMLobj.t)).sort(function(a,b){return a-b});tMap.forEach(function(value,key){tMap[key]=value.toString().replace(".","-")});slidesObj.head+="<style>"+slidesHTMLobj.style+"</style>";slidesObj.head+="<script>var tMap="+JSON.stringify(tMap)+", aspect="+slidesObj.aspect+(typeof slidesObj.t=="number"?", t0 = "+slidesObj.t:"")+"<\/script>";slidesObj.body+=slidesHTMLobj.body;if(slidesObj.scripts){slidesObj.scripts=Array.isArray(slidesObj.scripts)?slidesObj.scripts:[slidesObj.scripts];for(var i=0;i<slidesObj.scripts.length;i++){var script=slidesObj.scripts[i];if(_typeof(options.scripts)=="object"&&options.scripts[script]){slidesObj.body+="\n<script>"+options.scripts[script]+"<\/script>"}else{if(script.match(/^\/[^\/]/)!=null)script=path.join((options.renderSingle?__dirname:"")+options.resourceDir,script);else if(options.renderSingle)script=path.join(slidesPath,script);if(options.renderSingle){try{slidesObj.body+="\n<script>"+fs.readFileSync(script)+"<\/script>"}catch(err){if(err.code=="ENOENT"){console.log("Script '"+script+"' does not exist.")}else{callback(err);return}}}else{slidesObj.body+='\n<script src="'+script+'"><\/script>'}if(script.match(/three(?:\.min)?\.js$/)!=null)slidesObj.scripts.splice(i+1,0,"/slidesThree.js")}}}if(slidesObj.styles){slidesObj.styles=Array.isArray(slidesObj.styles)?slidesObj.styles:[slidesObj.styles];slidesObj.styles.forEach(function(style){if(style.match(/^\/[^\/]/)!=null)style=path.join((options.renderSingle?__dirname:"")+options.resourceDir,style);else if(options.renderSingle)style=path.join(slidesPath,style);if(options.renderSingle)try{slidesObj.head+="\n<style>"+fs.readFileSync(style)+"</style>"}catch(err){if(err.code=="ENOENT"){console.log("Stylesheet '"+style+"' does not exist.")}else{callback(err);return}}else slidesObj.head+='\n<link rel="stylesheet" type="text/css" href="'+style+'"></link>'})}if(!slidesObj.backgroundInverted)slidesObj.backgroundInverted=invertColour(slidesObj.background);for(var key in slidesObj){slidesObjRendered=slidesObjRendered.replace(new RegExp("\\${ *"+key+" *}","g"),slidesObj[key])}callback(null,slidesObjRendered,slidesObj)};if(typeof slides=="undefined"||(typeof slides==="undefined"?"undefined":_typeof(slides))=="object"&&typeof slides.slides=="undefined"){callback(new Error("Slides not specified"));return}else if(typeof slides=="string"){slidesObj.slides=slides}else if((typeof slides==="undefined"?"undefined":_typeof(slides))=="object"){for(var key in slides){slidesObj[key]=slides[key]}if(slides.slides)delete slides.slides}fs.readFile(slidesObj.templateFile,"utf8",function(err,data){if(err){if(err.code=="ENOENT"){callback(new Error("Template file '"+slidesObj.templateFile+"' does not exist"))}else{callback(err)}return}slidesObjRendered=data;if(typeof slidesObj.slides=="string"){var doParse=function doParse(data){var parseOptions=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return parse(data,parseOptions,function(err,obj){if(err){callback(err);return}for(var _key3 in obj){if((typeof slides==="undefined"?"undefined":_typeof(slides))!="object"||Object.keys(slides).indexOf(_key3)==-1)slidesObj[_key3]=obj[_key3]}slidesObjToHTML(slidesObj.slides,{dir:slidesPath,renderSingle:options.renderSingle},slidesInjectHTML)})};if(options.isPath!==false)fs.readFile(slidesObj.slides,"utf8",function(err,data){if(err){if(err.code=="ENOENT"){callback(new Error("Slides file '"+slidesObj.slides+"' does not exist"))}else{callback(err)}return}slidesPath=path.dirname(slidesObj.slides);doParse(data,{rootDir:slidesPath})});else doParse(slidesObj.slides)}else{slidesObjToHTML(slidesObj.slides,{renderSingle:options.renderSingle},slidesInjectHTML)}})}if(typeof module!=="undefined")module.exports={render:render};
